workflows:
  ios_ipa_adhoc:
    # 주의: AdHoc는 Apple Developer Portal에 "Ad Hoc" 프로파일(+UDID 등록)이 필요합니다.
    # 현재 Codemagic에서 ad_hoc 프로파일을 못 찾는 오류가 발생해,
    # 설치/테스트 배포는 TestFlight(App Store 타입) 워크플로우를 기본으로 사용하도록 설정했습니다.
    name: iOS IPA (TestFlight install)
    max_build_duration: 120
    instance_type: mac_mini_m2

    cache:
      cache_paths:
        - ~/.pub-cache
        - ~/Library/Caches/CocoaPods
        - ~/Library/Developer/Xcode/DerivedData/CompilationCache.noindex

    environment:
      flutter: stable
      xcode: latest

      ios_signing:
        distribution_type: app_store # app_store | ad_hoc | development | enterprise
        bundle_identifier: com.atx.pic.colorPickerTool

      vars:
        FLUTTER_APP_DIR: color_picker_tool
        IOS_BUNDLE_ID: com.atx.pic.colorPickerTool

    scripts:
      - name: Flutter pub get
        script: |
          cd "$FLUTTER_APP_DIR"
          flutter pub get

      - name: Install CocoaPods
        script: |
          cd "$FLUTTER_APP_DIR/ios"
          pod install

      - name: Set up code signing settings on Xcode project
        script: |
          cd "$FLUTTER_APP_DIR/ios"
          xcode-project use-profiles

      - name: Build IPA (Flutter)
        script: |
          cd "$FLUTTER_APP_DIR"
          BUILD_NUMBER="${CM_BUILD_NUMBER:-${BUILD_NUMBER:-1}}"
          flutter build ipa --release \
            --build-name="1.0.$BUILD_NUMBER" \
            --build-number="$BUILD_NUMBER"

    artifacts:
      - color_picker_tool/build/ios/ipa/*.ipa
      - color_picker_tool/build/ios/ipa/*.dSYM.zip
      - color_picker_tool/build/ios/archive/*.xcarchive
      - color_picker_tool/build/**/flutter_build.log

  ios_ipa_app_store:
    name: iOS IPA (App Store / TestFlight)
    max_build_duration: 120
    instance_type: mac_mini_m2

    cache:
      cache_paths:
        - ~/.pub-cache
        - ~/Library/Caches/CocoaPods
        - ~/Library/Developer/Xcode/DerivedData/CompilationCache.noindex

    environment:
      flutter: stable
      xcode: latest

      ios_signing:
        distribution_type: app_store
        bundle_identifier: com.atx.pic.colorPickerTool

      vars:
        FLUTTER_APP_DIR: color_picker_tool
        IOS_BUNDLE_ID: com.atx.pic.colorPickerTool

    scripts:
      - name: Flutter pub get
        script: |
          cd "$FLUTTER_APP_DIR"
          flutter pub get

      - name: Install CocoaPods
        script: |
          cd "$FLUTTER_APP_DIR/ios"
          pod install

      - name: Set up code signing settings on Xcode project
        script: |
          cd "$FLUTTER_APP_DIR/ios"
          xcode-project use-profiles

      - name: Build IPA (Flutter)
        script: |
          cd "$FLUTTER_APP_DIR"
          BUILD_NUMBER="${CM_BUILD_NUMBER:-${BUILD_NUMBER:-1}}"
          flutter build ipa --release \
            --build-name="1.0.$BUILD_NUMBER" \
            --build-number="$BUILD_NUMBER"

    artifacts:
      - color_picker_tool/build/ios/ipa/*.ipa
      - color_picker_tool/build/ios/ipa/*.dSYM.zip
      - color_picker_tool/build/ios/archive/*.xcarchive
      - color_picker_tool/build/**/flutter_build.log

